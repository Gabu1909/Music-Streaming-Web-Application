import{E as w}from"./EntityTable-DpMCeHs3.js";import{F as y,B as F}from"./FormFields-D9uIRFc5.js";import{_ as p,m as M,p as S,D as f,o as c,l as h,c as m,d as g,a as o,f as d,t as l,O as b,F as D,C as u}from"./index-DTmEoMLP.js";const E={name:"ArtistModal",components:{BaseModal:F,FormFields:y},props:{show:{type:Boolean,default:!1},artist:{type:Object,default:()=>({})},mode:{type:String,default:"add",validator:e=>["add","edit"].includes(e)},showDebug:{type:Boolean,default:!1}},emits:["save","cancel","success","error"],data(){return{isSaving:!1,selectedAvatarFile:null,errorMessage:"",successMessage:"",artistData:{id:null,name:"",bio:""}}},computed:{isFormValid(){const e=!!(this.artistData.name&&this.artistData.name.trim().length>0);return e&&this.errorMessage&&(this.errorMessage=""),!!e}},watch:{artist:{handler(e){this.updateFormData(e)},immediate:!0,deep:!0},show(e){e?(this.resetModal(),this.updateFormData(this.artist)):this.resetModal()}},methods:{resetModal(){this.selectedAvatarFile=null,this.isSaving=!1,this.errorMessage="",this.successMessage=""},updateFormData(e){const t=e||{};this.artistData={id:t.artist_id||t.id||null,name:String(t.name||"").trim(),bio:String(t.bio||"").trim()},console.log("Artist form data updated:",{...this.artistData,originalArtist:t,isValidAfterUpdate:this.isFormValid})},validateForm(){this.errorMessage="",this.successMessage=""},handleAvatarSelected(e){this.selectedAvatarFile=e,this.errorMessage="",console.log("Avatar selected:",e.name,this.formatFileSize(e.size))},handleAvatarRemoved(){this.selectedAvatarFile=null,console.log("Avatar removed")},handleCancel(){this.isSaving||(this.resetModal(),this.$emit("cancel"))},async saveArtist(){if(this.isSaving){console.log("Save already in progress, ignoring duplicate request");return}if(!this.isFormValid){this.errorMessage="Please enter the artist name.",console.error("Form validation failed:",{isFormValid:this.isFormValid,artistData:this.artistData});return}this.isSaving=!0,this.errorMessage="",this.successMessage="";try{const e=this.prepareFormData(),t={name:this.artistData.name.trim(),bio:this.artistData.bio.trim()||"(empty)",hasAvatar:!!this.selectedAvatarFile,avatarFileName:this.selectedAvatarFile?.name||"(none)",mode:this.mode,id:this.artistData.id||"(none)"};console.log("Saving artist with data:",t),await this.handleSaveResponse(e)}catch(e){console.error("Error in saveArtist:",e),this.isSaving=!1}},prepareFormData(){const e=new FormData,t=this.artistData.name.trim();if(!t)throw new Error("Artist name is required");e.append("name",t);const s=this.artistData.bio.trim();if(s&&e.append("bio",s),this.selectedAvatarFile){if(this.selectedAvatarFile.size>10*1024*1024)throw new Error("Avatar file size must be less than 10MB");e.append("avatar_url",this.selectedAvatarFile)}if(this.mode==="edit"){if(!this.artistData.id)throw new Error("Artist ID is missing for edit operation");e.append("artist_id",this.artistData.id),console.log("Edit mode - Artist ID added to FormData:",this.artistData.id)}return e},async handleSaveResponse(e){return new Promise((t,s)=>{const a=setTimeout(()=>{this.isSaving=!1;const n=new Error("Save operation timed out. Please try again.");this.errorMessage=n.message,s(n)},3e4),r=()=>{clearTimeout(a),this.isSaving=!1,this.successMessage=`Artist ${this.mode==="edit"?"updated":"created"} successfully!`,this.$emit("success"),setTimeout(()=>{this.handleCancel()},1500),t()},i=n=>{clearTimeout(a),this.isSaving=!1,this.errorMessage=n?.message||"An error occurred while saving",s(n)};this.$emit("save",e,{onSuccess:r,onError:i})})},getFileName(e){if(!e)return"Unknown";const t=String(e).split("/");return t[t.length-1]||"Unknown"},formatFileSize(e){if(!e||e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(2))+" "+s[a]}}},_={key:0,class:"current-file-info"},N={class:"field-note"},B={key:1,class:"error-message"},P={key:2,class:"success-message"},V={key:3,class:"debug-info"};function k(e,t,s,a,r,i){const n=f("FormFields"),v=f("BaseModal");return c(),M(v,{show:s.show,mode:s.mode,title:"Artist","form-data":r.artistData,"is-form-valid":i.isFormValid,"is-saving":r.isSaving,onSave:i.saveArtist,onCancel:i.handleCancel},{"form-content":S(()=>[h(n,{type:"text",label:"Artist's Full Name",modelValue:r.artistData.name,"onUpdate:modelValue":t[0]||(t[0]=A=>r.artistData.name=A),placeholder:"Enter artist's full name",required:"",disabled:r.isSaving,onInput:i.validateForm},null,8,["modelValue","disabled","onInput"]),h(n,{type:"textarea",label:"Biography",modelValue:r.artistData.bio,"onUpdate:modelValue":t[1]||(t[1]=A=>r.artistData.bio=A),placeholder:"Short biography of the artist",rows:4,disabled:r.isSaving,note:"Optional: Brief description about the artist"},null,8,["modelValue","disabled"]),h(n,{type:"file",label:"Avatar Image",accept:"image/*","max-size":10*1024*1024,disabled:r.isSaving,note:"Avatar will be stored as binary data (max 10MB)",onFileSelected:i.handleAvatarSelected,onFileRemoved:i.handleAvatarRemoved},null,8,["disabled","onFileSelected","onFileRemoved"]),s.mode==="edit"&&s.artist.avatar_url&&!r.selectedAvatarFile?(c(),m("div",_,[o("div",N,[t[2]||(t[2]=o("strong",null,"Current avatar:",-1)),d(" "+l(i.getFileName(s.artist.avatar_url)),1)])])):g("",!0),r.errorMessage?(c(),m("div",B,[o("p",null,l(r.errorMessage),1)])):g("",!0),r.successMessage?(c(),m("div",P,[o("p",null,l(r.successMessage),1)])):g("",!0),s.showDebug?(c(),m("div",V,[o("p",null,[t[3]||(t[3]=o("strong",null,"Form Valid:",-1)),d(" "+l(i.isFormValid),1)]),o("p",null,[t[4]||(t[4]=o("strong",null,"Has Name:",-1)),d(" "+l(!!r.artistData.name.trim()),1)]),o("p",null,[t[5]||(t[5]=o("strong",null,"Mode:",-1)),d(" "+l(s.mode),1)]),o("p",null,[t[6]||(t[6]=o("strong",null,"Has Avatar:",-1)),d(" "+l(!!r.selectedAvatarFile),1)]),o("p",null,[t[7]||(t[7]=o("strong",null,"Avatar File Name:",-1)),d(" "+l(r.selectedAvatarFile?.name||"None"),1)]),o("p",null,[t[8]||(t[8]=o("strong",null,"Is Saving:",-1)),d(" "+l(r.isSaving),1)])])):g("",!0)]),_:1},8,["show","mode","form-data","is-form-valid","is-saving","onSave","onCancel"])}const x=p(E,[["render",k],["__scopeId","data-v-64e85f5d"]]),C={name:"Artists",components:{EntityTable:w,ArtistModal:x},data(){return{artists:[],showModal:!1,selectedArtist:null,modalMode:"add",isProcessing:!1,tableConfig:{tableTitle:"Artists Hub",entityName:"artists",searchPlaceholder:"Search artists by name...",addButtonText:"Add Artist",emptyMessage:"No artists found. Create your first artist to get started.",itemsPerPage:15,searchableColumns:["name"],columns:[{key:"avatar_url",label:"Avatar",type:"avatar",sortable:!1,maxLength:0},{key:"artist_id",label:"ID",type:"text",sortable:!0,maxLength:10},{key:"name",label:"Artist Name",type:"text",sortable:!0,maxLength:35},{key:"actions",label:"Actions",type:"actions",sortable:!1,maxLength:0}]}}},methods:{async fetchArtists(){try{console.log("Starting fetchArtists, artistService:",u);const e=await u.getAllArtists();console.log("API Response from getAllArtists:",e);let t=[];e&&e.status==="success"&&e.data?Array.isArray(e.data)?t=e.data:e.data.artists?t=e.data.artists:e.data.data&&(t=e.data.data):Array.isArray(e)&&(t=e),this.artists=t.map(s=>({artist_id:s.artist_id||s.id,name:s.name||"Unknown Artist",bio:s.bio||"",avatar_url:s.avatar_url?`/public/uploads/images${s.avatar_url}`:null})),console.log("Mapped artists:",this.artists)}catch(e){console.error("FetchArtists error:",e),this.artists=[],this.showNotification("Failed to load artists","error")}},openAddArtist(){this.selectedArtist={},this.modalMode="add",this.showModal=!0},openEditArtist(e){this.selectedArtist=e?{...e}:{},this.modalMode="edit",this.showModal=!0},viewArtist(e){if(!e)return;const t=[`ID: ${e.artist_id||"N/A"}`,`Name: ${e.name||"N/A"}`,`Bio: ${e.bio||"No biography available"}`,`Avatar: ${e.avatar_url?"Yes":"No"}`].join(`
`);alert(`Artist Details:
${t}`)},async deleteArtist(e){if(!e||!e.artist_id){this.showNotification("Invalid artist data","error");return}if(confirm(`Are you sure you want to delete artist "${e.name}"?`))try{await u.deleteArtist(e.artist_id),this.artists=this.artists.filter(t=>t.artist_id!==e.artist_id),this.showNotification(`Artist "${e.name}" has been deleted successfully.`,"success"),await this.fetchArtists()}catch(t){console.error("Delete artist error:",t),this.showNotification(`Failed to delete artist: ${t.message}`,"error"),await this.fetchArtists()}},async handleArtistSave(e,t){if(this.isProcessing){console.log("Save operation already in progress"),t?.onError(new Error("Save operation already in progress"));return}this.isProcessing=!0;try{console.log("Processing artist save:",{mode:this.modalMode,formData:this.debugFormData(e)});let s;if(this.modalMode==="edit"){const a=e.get("artist_id");if(!a)throw new Error("Artist ID is required for update operation");console.log("Updating artist with ID:",a),s=await u.updateArtist(a,e)}else console.log("Creating new artist"),s=await u.createArtist(e);if(console.log("Save response:",s),s&&(s.status==="success"||s.success))t?.onSuccess();else{const a=this.extractErrorMessage(s);throw new Error(a)}}catch(s){console.error("Artist save error:",s);const a=this.createFriendlyError(s);t?.onError(a)}finally{this.isProcessing=!1}},debugFormData(e){const t=[];for(const[s,a]of e.entries())a instanceof File?t.push([s,`File: ${a.name} (${a.size} bytes)`]):t.push([s,a]);return t},extractErrorMessage(e){return e?.message?e.message:e?.error?e.error:e?.data?.message?e.data.message:"Save operation failed"},createFriendlyError(e){const t=e.message||e.toString();if(t.includes("HTTP error! status: 500")){const s=t.match(/body: ({.*})/);if(s)try{const a=JSON.parse(s[1]);if(a.message&&a.message!=="Internal server error")return new Error(`Server error: ${a.message}`)}catch{}return new Error("Server error occurred. Please check your data and try again.")}return t.includes("HTTP error! status: 400")?new Error("Invalid data submitted. Please check your input."):t.includes("HTTP error! status: 401")?new Error("Authentication required. Please log in again."):t.includes("HTTP error! status: 403")?new Error("You do not have permission to perform this action."):t.includes("timeout")?new Error("Request timed out. Please try again."):t.includes("Network")?new Error("Network error. Please check your connection."):e},async onArtistSuccess(){console.log("Artist saved successfully"),await this.fetchArtists();const e=this.modalMode==="edit"?"updated":"created";this.showNotification(`Artist has been ${e} successfully!`,"success")},onArtistError(e){console.error("Artist save error from modal:",e),e&&e.message?this.showNotification(`${e.message}`,"error"):this.showNotification("An unknown error occurred while saving","error")},closeModal(){this.showModal=!1,this.selectedArtist=null,this.modalMode="add",this.isProcessing=!1},showNotification(e,t="info"){alert(t==="error"?`❌ ${e}`:t==="success"?`✅ ${e}`:`ℹ️ ${e}`),console.log(`[${t.toUpperCase()}] ${e}`)}},async mounted(){console.log("Artists component mounted"),console.log("Calling fetchArtists...");try{await this.fetchArtists()}catch(e){console.error("Error during initial fetch:",e),this.showNotification("Failed to load initial data","error")}}};function T(e,t,s,a,r,i){const n=f("EntityTable"),v=f("ArtistModal");return c(),m(D,null,[h(n,b(r.tableConfig,{rows:r.artists,onAdd:i.openAddArtist,onEdit:i.openEditArtist,onDelete:i.deleteArtist,onView:i.viewArtist}),null,16,["rows","onAdd","onEdit","onDelete","onView"]),h(v,{show:r.showModal,artist:r.selectedArtist||{},mode:r.modalMode,onSave:i.handleArtistSave,onCancel:i.closeModal,onSuccess:i.onArtistSuccess,onError:i.onArtistError},null,8,["show","artist","mode","onSave","onCancel","onSuccess","onError"])],64)}const U=p(C,[["render",T]]);export{U as default};
