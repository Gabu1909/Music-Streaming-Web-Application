import{E as A}from"./EntityTable-BSKhrtxt.js";import{F as b,B as F}from"./FormFields-B3pZe_m_.js";import{_ as y,m as _,p as S,D as h,o as m,l as d,c,d as p,a as i,f as n,t as r,N as w,F as v}from"./index-BH3AGQtF.js";import{S as g}from"./song.service-BEFtWEPn.js";const M={name:"SongModal",components:{BaseModal:F,FormFields:b},props:{show:{type:Boolean,default:!1},song:{type:Object,default:()=>({})},mode:{type:String,default:"add"}},emits:["save","cancel"],data(){return{isSaving:!1,selectedAudioFile:null,audioDuration:null,songData:{id:null,title:"",artist:"",album:""},showDebug:!0}},computed:{hasAudioFile(){return this.mode==="edit"?this.selectedAudioFile||this.song&&this.song.audio_files:!!this.selectedAudioFile},isFormValid(){return!!(this.songData.title.trim()&&this.songData.artist.trim())&&!!this.hasAudioFile}},watch:{song:{handler(t){this.updateFormData(t)},immediate:!0,deep:!0},show(t){t&&(this.updateFormData(this.song),this.selectedAudioFile=null,this.audioDuration=null)}},methods:{updateFormData(t){const e=t||{};this.songData={id:e.song_id||e.id||null,title:e.title||"",artist:e.artist_name||(e.artists&&e.artists.length>0?e.artists[0].name:"")||"",album:e.album||""},console.log("Updated songData:",this.songData)},handleAudioSelected(t){this.selectedAudioFile=t,this.getAudioDuration(t)},handleAudioRemoved(){this.selectedAudioFile=null,this.audioDuration=null},getAudioDuration(t){const e=new Audio,o=URL.createObjectURL(t);e.addEventListener("loadedmetadata",()=>{this.audioDuration=e.duration,URL.revokeObjectURL(o)}),e.addEventListener("error",()=>{URL.revokeObjectURL(o)}),e.src=o},async saveSong(){if(this.isFormValid){this.isSaving=!0;try{const t=new FormData;t.append("title",this.songData.title.trim()),t.append("artist",this.songData.artist.trim()),this.songData.album.trim()&&t.append("album",this.songData.album.trim()),this.selectedAudioFile&&t.append("audio_files",this.selectedAudioFile),this.$emit("save",t)}catch(t){console.error("Error preparing data:",t),alert("Error preparing data")}finally{this.isSaving=!1}}},getFileName(t){if(!t)return"Unknown";const e=t.split("/");return e[e.length-1]||"Unknown"},formatDuration(t){if(!t)return"";const e=Math.floor(t/60),o=Math.floor(t%60);return`${e}:${o.toString().padStart(2,"0")}`}}},E={key:0,class:"current-file-info"},V={class:"field-note"},k={key:1,class:"audio-info"},x={class:"field-note"},U={key:2,class:"debug-info"};function L(t,e,o,D,a,s){const l=h("FormFields"),f=h("BaseModal");return m(),_(f,{show:o.show,mode:o.mode,title:"Song","form-data":a.songData,"is-form-valid":s.isFormValid,"is-saving":a.isSaving,onSave:s.saveSong,onCancel:e[3]||(e[3]=u=>t.$emit("cancel"))},{"form-content":S(()=>[d(l,{type:"row"},{default:S(()=>[d(l,{type:"text",label:"Title",modelValue:a.songData.title,"onUpdate:modelValue":e[0]||(e[0]=u=>a.songData.title=u),placeholder:"Enter song title",required:""},null,8,["modelValue"]),d(l,{type:"text",label:"Artist",modelValue:a.songData.artist,"onUpdate:modelValue":e[1]||(e[1]=u=>a.songData.artist=u),placeholder:"Enter artist name",required:""},null,8,["modelValue"])]),_:1}),d(l,{type:"text",label:"Album",modelValue:a.songData.album,"onUpdate:modelValue":e[2]||(e[2]=u=>a.songData.album=u),placeholder:"Album name (optional)"},null,8,["modelValue"]),d(l,{type:"file",label:"Audio File",accept:"audio/*",required:o.mode==="add",note:o.mode==="add"?"Audio file is required for new songs (any size)":"Upload new audio file to replace current one",onFileSelected:s.handleAudioSelected,onFileRemoved:s.handleAudioRemoved},null,8,["required","note","onFileSelected","onFileRemoved"]),o.mode==="edit"&&o.song.audio_files&&!a.selectedAudioFile?(m(),c("div",E,[i("div",V,[e[4]||(e[4]=i("strong",null,"Current file:",-1)),n(" "+r(s.getFileName(o.song.audio_files)),1)])])):p("",!0),a.audioDuration?(m(),c("div",k,[i("div",x,[e[5]||(e[5]=i("strong",null,"Duration:",-1)),n(" "+r(s.formatDuration(a.audioDuration)),1)])])):p("",!0),a.showDebug?(m(),c("div",U,[i("p",null,[e[6]||(e[6]=i("strong",null,"Form Valid:",-1)),n(" "+r(s.isFormValid),1)]),i("p",null,[e[7]||(e[7]=i("strong",null,"Has Title:",-1)),n(" "+r(!!a.songData.title.trim()),1)]),i("p",null,[e[8]||(e[8]=i("strong",null,"Has Artist:",-1)),n(" "+r(!!a.songData.artist.trim()),1)]),i("p",null,[e[9]||(e[9]=i("strong",null,"Has Audio:",-1)),n(" "+r(s.hasAudioFile),1)]),i("p",null,[e[10]||(e[10]=i("strong",null,"Mode:",-1)),n(" "+r(o.mode),1)])])):p("",!0)]),_:1},8,["show","mode","form-data","is-form-valid","is-saving","onSave"])}const N=y(M,[["render",L]]),R={name:"Songs",components:{EntityTable:A,SongModal:N},data(){return{songs:[],showModal:!1,selectedSong:null,modalMode:"add",tableConfig:{tableTitle:"Songs Library",entityName:"songs",searchPlaceholder:"Search songs by title, artist...",addButtonText:"Add Song",emptyMessage:"No songs found. Upload your first song to get started.",showPlayButton:!1,itemsPerPage:20,searchableColumns:["title","artist_name"],columns:[{key:"song_id",label:"ID",type:"text",sortable:!0,maxLength:10},{key:"title",label:"Title",type:"text",sortable:!0,maxLength:40},{key:"artist_name",label:"Artist",type:"text",sortable:!0,maxLength:30},{key:"duration",label:"Duration",type:"duration",sortable:!0},{key:"audio_url",label:"Audio File",type:"text",sortable:!1,maxLength:25},{key:"actions",label:"Actions",type:"actions",sortable:!1}]}}},methods:{async fetchSongs(){try{const t=await g.getSongs();let e=[];Array.isArray(t)?e=t:t?.data&&(e=Array.isArray(t.data)?t.data:t.data.songs||[]),this.songs=e.map(o=>({song_id:o.song_id||o.id,title:o.title||"Unknown Title",artist_name:this.getArtistName(o),duration:o.duration||0,audio_url:o.audio_url||"",image_url:o.image_url||null,artists:o.artists||[]}))}catch(t){console.error("Error fetching songs:",t),alert(`Failed to load songs: ${t.message}`),this.songs=[]}},getArtistName(t){return t.artists?.length?t.artists.map(e=>e.name).join(", "):t.artist_name||"Unknown Artist"},async saveSong(t){try{let e;if(this.modalMode==="edit"&&this.selectedSong?.song_id?e=await g.updateSong(this.selectedSong.song_id,t):e=await g.createSong(t),console.log("API response:",e),e.error)throw new Error(e.error);this.closeModal(),await this.fetchSongs(),alert("Operation completed successfully")}catch(e){console.error("Error saving song:",e),alert(`Error: ${e.message}`)}},openAddSong(){this.selectedSong={},this.modalMode="add",this.showModal=!0},openEditSong(t){this.selectedSong={...t},this.modalMode="edit",this.showModal=!0},viewSong(t){if(!t)return;const e=`
ID: ${t.song_id}
Title: ${t.title}
Artist(s): ${t.artist_name}
Duration: ${this.formatDuration(t.duration)}
Audio: ${t.audio_url||"None"}
Image: ${t.image_url||"None"}
`;alert(e)},async deleteSong(t){if(!(!t||!t.song_id))try{await g.deleteSong(t.song_id),this.songs=this.songs.filter(e=>e.song_id!==t.song_id),alert(`Deleted "${t.title}" successfully.`)}catch(e){console.error("Error deleting:",e),alert(`Failed to delete song: ${e.message}`)}},closeModal(){this.showModal=!1,this.selectedSong=null,this.modalMode="add"},formatDuration(t){const e=Math.floor(t/60),o=Math.floor(t%60);return`${e}:${o.toString().padStart(2,"0")}`}},mounted(){this.fetchSongs()}};function B(t,e,o,D,a,s){const l=h("EntityTable"),f=h("SongModal");return m(),c(v,null,[d(l,w(a.tableConfig,{rows:a.songs,onAdd:s.openAddSong,onEdit:s.openEditSong,onDelete:s.deleteSong,onView:s.viewSong}),null,16,["rows","onAdd","onEdit","onDelete","onView"]),d(f,{show:a.showModal,song:a.selectedSong||{},mode:a.modalMode,onSave:s.saveSong,onCancel:s.closeModal},null,8,["show","song","mode","onSave","onCancel"])],64)}const O=y(R,[["render",B]]);export{O as default};
